<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Laporan Bantuan</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #f8f9fa;
      }
      .form-container {
        max-width: 95%;
        margin: 30px auto;
        padding: 10px;
        background-color: transparent;
        border-radius: 8px;
      }
      .form-container h2 {
        margin-bottom: 20px;
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <div class="row">
        <div class="col-md-5">
          <div class="card card-body shadow">
            <h3 class="text-center">Data Sekolah</h3>
            <hr />
            <form id="schoolForm">
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="npsn" class="form-label">NPSN</label>
                </div>
                <div class="col-md-8">
                  <input type="text" class="form-control" id="npsn" readonly />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="sekolah" class="form-label">Nama Sekolah</label>
                </div>
                <div class="col-md-8">
                  <input
                    type="text"
                    class="form-control"
                    id="sekolah"
                    readonly
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="alamat" class="form-label">Alamat</label>
                </div>
                <div class="col-md-8">
                  <input
                    type="text"
                    class="form-control"
                    id="alamat"
                    readonly
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="kecamatan" class="form-label">Kecamatan</label>
                </div>
                <div class="col-md-8">
                  <input
                    type="text"
                    class="form-control"
                    id="kecamatan"
                    readonly
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="kepala_sekolah" class="form-label"
                    >Kepala Sekolah</label
                  >
                </div>
                <div class="col-md-8">
                  <input
                    type="text"
                    class="form-control"
                    id="kepala_sekolah"
                    readonly
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="nip" class="form-label">NIP</label>
                </div>
                <div class="col-md-8">
                  <input type="text" class="form-control" id="nip" readonly />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="usulan" class="form-label">Ajuan Bantuan</label>
                </div>
                <div class="col-md-8">
                  <input
                    type="text"
                    class="form-control"
                    id="usulan"
                    readonly
                  />
                </div>
              </div>
            </form>
          </div>
        </div>
        <div class="col-md-7">
          <div class="card card-body shadow">
            <h4 class="text-center">
              Laporan Bantuan Seragam dan Perlengkapan Lainnya
            </h4>
            <form id="uniformForm">
              <div class="mb-3 row">
                <center>
                  <h5 class="bg-secondary text-light p-1">Seragam OSIS</h5>
                </center>
                <div class="col-md-3">
                  <label for="osis" class="form-label">Jumlah Diterima</label>
                  <input
                    type="number"
                    class="form-control"
                    id="osis"
                    required
                  />
                </div>
                <div class="col-md-9">
                  <label for="osis_keterangan" class="form-label"
                    >Keterangan</label
                  >
                  <textarea
                    class="form-control"
                    id="osis_keterangan"
                    rows="3"
                    required
                  ></textarea>
                </div>
              </div>
              <div class="mb-3 row">
                <center>
                  <h5 class="bg-secondary text-light p-1">Seragam Pramuka</h5>
                </center>
                <div class="col-md-3">
                  <label for="pramuka" class="form-label"
                    >Jumlah Diterima</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="pramuka"
                    required
                  />
                </div>
                <div class="col-md-9">
                  <label for="pramuka_keterangan" class="form-label"
                    >Keterangan</label
                  >
                  <textarea
                    class="form-control"
                    id="pramuka_keterangan"
                    rows="3"
                    required
                  ></textarea>
                </div>
              </div>
              <div class="mb-3 row">
                <center>
                  <h5 class="bg-secondary text-light p-1">Aksesoris</h5>
                </center>
                <div class="col-md-3">
                  <label for="aksesoris" class="form-label"
                    >Jumlah Diterima</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="aksesoris"
                    required
                  />
                </div>
                <div class="col-md-9">
                  <label for="aksesoris_keterangan" class="form-label"
                    >Keterangan</label
                  >
                  <textarea
                    class="form-control"
                    id="aksesoris_keterangan"
                    rows="3"
                    required
                  ></textarea>
                </div>
              </div>
              <div class="col-md-12 text-center">
                <button type="submit" class="btn btn-primary">Submit</button>
              </div>
            </form>
          </div>
        </div>
        <div class="col-12 card card-body mt-4">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>NPSN</th>
                <th>Sekolah</th>
                <th>Usulan</th>
                <th>Seragan Osis</th>
                <th>Keterangan</th>
                <th>Seragam Pramuka</th>
                <th>Keterangan</th>
                <th>Aksesoris</th>
                <th>Keterangan</th>
              </tr>
            </thead>
            <tbody id="dataTableBody">
              <!-- Data will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // Function to decrypt data
      function decryptData(data) {
        return JSON.parse(atob(data));
      }

      // Load school data on page load
      window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const encryptedData = urlParams.get("data");
        if (encryptedData) {
          const schoolData = decryptData(encryptedData);
          document.getElementById("npsn").value = schoolData.npsn;
          document.getElementById("sekolah").value = schoolData.sekolah;
          document.getElementById("alamat").value = schoolData.alamat;
          document.getElementById("kecamatan").value = schoolData.kecamatan;
          document.getElementById("kepala_sekolah").value =
            schoolData.kepala_sekolah;
          document.getElementById("nip").value = schoolData.nip;
          document.getElementById("usulan").value = schoolData.usulan;
          document.getElementById("osis").value = schoolData.osis || "";
          document.getElementById("osis_keterangan").value =
            schoolData.osis_keterangan || "";
          document.getElementById("pramuka").value = schoolData.pramuka || "";
          document.getElementById("pramuka_keterangan").value =
            schoolData.pramuka_keterangan || "";
          document.getElementById("aksesoris").value =
            schoolData.aksesoris || "";
          document.getElementById("aksesoris_keterangan").value =
            schoolData.aksesoris_keterangan || "";

          const apiUrl =
            "https://script.google.com/macros/s/AKfycbxjs3510ccQkbXt6hrfEvnl8lUlugUSqFwrZoOaBAOvgUb9fqWQJ9RNjoCl-I1MK6ID/exec?sheet=data";

          fetch(apiUrl)
            .then((response) => response.json())
            .then((data) => {
              let tableBody = document.getElementById("dataTableBody");
              data.forEach((item, index) => {
                const laporanNPSN = item.laporan;

                // Filter based on NPSN value
                if (schoolData.npsn === laporanNPSN) {
                  let row = document.createElement("tr");
                  row.innerHTML = `
                          <td>${item.laporan}</td>
                          <td>${item.sekolah}</td>
                          <td>${item.usulan}</td>
                          <td>${item.osis}</td>
                          <td>${item.osis_ket}</td>
                          <td>${item.pramuka}</td>
                          <td>${item.pramuka_ket}</td>
                          <td>${item.aksesoris}</td>
                          <td>${item.aksesoris_ket}</td>
                        `;
                  tableBody.appendChild(row);
                }
              });
            })
            .catch((error) => console.error("Error:", error));
        } else {
          alert("No data found");
        }
      };

      // Handle form submission
      document
        .getElementById("uniformForm")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // Prevent default form submission

          const npsn = document.getElementById("npsn").value;
          const sekolah = document.getElementById("sekolah").value;
          const alamat = document.getElementById("alamat").value;
          const kecamatan = document.getElementById("kecamatan").value;
          const kepala_sekolah =
            document.getElementById("kepala_sekolah").value;
          const nip = document.getElementById("nip").value;
          const usulan = document.getElementById("usulan").value;
          const osis = document.getElementById("osis").value;
          const osis_keterangan =
            document.getElementById("osis_keterangan").value;
          const pramuka = document.getElementById("pramuka").value;
          const pramuka_keterangan =
            document.getElementById("pramuka_keterangan").value;
          const aksesoris = document.getElementById("aksesoris").value;
          const aksesoris_keterangan = document.getElementById(
            "aksesoris_keterangan"
          ).value;

          // Check if any of the required fields are empty
          if (
            !npsn ||
            !sekolah ||
            !alamat ||
            !kecamatan ||
            !kepala_sekolah ||
            !nip ||
            !usulan
          ) {
            alert("Please ensure all fields are filled out.");
            return;
          }

          // Prepare the data for submission
          const formData = {
            "entry.1937631403": `${npsn}|${sekolah}|${alamat}|${kecamatan}|${kepala_sekolah}|${nip}|${usulan}|${osis}|${osis_keterangan}|${pramuka}|${pramuka_keterangan}|${aksesoris}|${aksesoris_keterangan}`,
          };

          // Submit to Google Form
          const googleFormUrl =
            "https://docs.google.com/forms/d/e/1FAIpQLSeeDN51d1GHhAv5yRn6OUluqs_uSTAzeVVJ9gUhhnfFHHpPMg/formResponse";
          const dataString = new URLSearchParams(formData).toString();

          setTimeout(function () {
            location.reload();
          }, 3000); // 5000 milliseconds = 5 seconds

          fetch(googleFormUrl + "?" + dataString, {
            method: "GET",
          })
            .then(() => {
              alert("Form successfully submitted! Data berhasil disimpan.");
              // Redirect after successful submission (optional)
            })
            .catch((error) => console.error("Error submitting form:", error));
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
